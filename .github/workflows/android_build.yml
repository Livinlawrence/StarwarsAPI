  name: Android Build

  on:
    push:
      branches:
        - main
        - temp
  jobs:
    build:
      runs-on: ubuntu-latest
      timeout-minutes: 30

      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Copy CI gradle.properties
          run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

        - name: Set up JDK 11
          uses: actions/setup-java@v1
          with:
              java-version: 11

        - name: Build project
          run: ./gradlew assemble

        - name: Upload build outputs (APKs)
          uses: actions/upload-artifact@v2
          with:
            name: build-outputs
            path: app/build/outputs
            tag_name: v1.0.0
            asset_path: app/build/outputs/apk/debug/app-debug.apk
            asset_name: Example.apk
            asset_content_type: application/zip

        - name: Upload build reports
          if: always()
          uses: actions/upload-artifact@v2
          with:
            name: build-reports
            path: app/build/reports

        - name: Run_test
          run: ./gradlew test

    test:
      needs: build
      runs-on: macOS-latest # enables hardware acceleration in the virtual machine
      timeout-minutes: 30
      strategy:
        matrix:
          api-level: [ 23, 26, 29 ]

      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Copy CI gradle.properties
          run: mkdir -p ~/.gradle ; cp .github/ci-gradle.properties ~/.gradle/gradle.properties

        - name: Set up JDK 11
          uses: actions/setup-java@v1
          with:
            java-version: 11

        - name: Run instrumentation tests
          uses: reactivecircus/android-emulator-runner@v2
          with:
            api-level: ${{ matrix.api-level }}
            arch: x86
            disable-animations: true
            script: ./gradlew connectedCheck --stacktrace

        - name: Upload test reports
          if: always()
          uses: actions/upload-artifact@v2
          with:
            name: test-reports
            path: app/build/reports